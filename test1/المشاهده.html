<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>مشاهدة الحلقة</title>
  <meta name="description" content="عرض أنمي ديناميكي" id="meta-description">
  <link rel="stylesheet" href="../CSS/episodes.css">
  <link rel="stylesheet" href="../CSS/style.css">
  <script type="module" src="/RS.js"></script>
  <script type="module" src="../navbar.js"></script>
  <link rel="icon" href="https://abdo838.github.io/1/navbar/favicon.ico" type="image/x-icon">
</head>

<body>
  <div id="navbar-container"></div>

  <div class="container">
    <main class="main-content">
      <div class="anime-info-header">
        <h2 id="anime-title">جارٍ التحميل...</h2>
        <p id="episode-title">رقم الحلقة: ...</p>
      </div>

      <div class="server-buttons" id="server-buttons-container"></div>

      <div class="video-container">
        <!-- صورة الحلقة + زر التشغيل -->
        <div class="episode-image-container" id="episode-image-wrapper">
          <img id="episode-image" src="" alt="صورة الحلقة" />
          <button id="play-button">تشغيل الحلقة</button>
        </div>

        <!-- مشغل الفيديو -->
        <iframe id="video-player" allowfullscreen></iframe>
      </div>

      <div class="navigation-buttons">
        <button id="prev-btn">السابق</button>
        <button id="next-btn">التالي</button>
      </div>
    </main>

    <aside class="episodes">
      <h2>جميع الحلقات</h2>
      <ul id="episodes-list"></ul>
    </aside>
  </div>

  <script>
    let episodes = [];
    let currentEpisodeIndex = 0;
    let currentServerName = "";

    const episodesList = document.getElementById("episodes-list");
    const videoPlayer   = document.getElementById("video-player");
    const animeTitle    = document.getElementById("anime-title");
    const episodeTitle  = document.getElementById("episode-title");
    const prevBtn       = document.getElementById("prev-btn");
    const nextBtn       = document.getElementById("next-btn");
    const serverButtons = document.getElementById("server-buttons-container");
    const episodeImage  = document.getElementById("episode-image");
    const playButton    = document.getElementById("play-button");
    const imageWrapper  = document.getElementById("episode-image-wrapper");

    function getQueryParam(param) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(param);
    }

    function setEpisodeFromURL() {
      let ep = getQueryParam("episode");
      if (!ep || ep === "None" || ep === "null" || isNaN(ep)) {
        playEpisode(0, false);
        return;
      }
      ep = parseInt(ep, 10);
      let index = episodes.findIndex(e => e.number == ep);
      if (index !== -1) playEpisode(index, false);
      else playEpisode(0, false);
    }

    function loadEpisodesData() {
      const animeId = getQueryParam("id");
      if (!animeId) return;

      fetch(`episodes/${animeId}.json`)
        .then(res => res.json())
        .then(data => {
          episodes = data.episodes;
          episodes.sort((a, b) => a.number - b.number);
          animeTitle.textContent = data.animeTitle;
          setEpisodeFromURL();
          loadEpisodes();
        })
        .catch(err => {
          console.error(err);
          document.body.innerHTML = "<h1>خطأ في تحميل الحلقات</h1>";
        });
    }

    function loadEpisodes() {
      episodesList.innerHTML = "";
      episodes.forEach((episode, index) => {
        const li = document.createElement("li");
        li.className = "episode-item";
        li.textContent = episode.title;
        if (index === currentEpisodeIndex) li.classList.add("active");
        li.addEventListener("click", () => {
          const newUrl = `?id=${getQueryParam("id")}&episode=${episode.number}`;
          history.pushState({}, "", newUrl);
          playEpisode(index, false);
        });
        episodesList.appendChild(li);
      });
    }

    function playEpisode(index, autoPlay = true) {
      currentEpisodeIndex = index;
      const ep = episodes[index];

      episodeTitle.textContent = `رقم الحلقة: ${ep.number}`;
      document.title = `${animeTitle.textContent} - الحلقة ${ep.number}`;
      currentServerName = ep.servers[0].serverName;

      // تحديث صورة الحلقة
      if (ep.image) {
        episodeImage.src = ep.image;
        imageWrapper.style.display = "block";
      } else {
        imageWrapper.style.display = "none";
        if (autoPlay) startVideo(ep.servers[0].url);
      }

      // إذا autoPlay true (مثل التنقل من السابق/التالي)، ابدأ الفيديو
      if (autoPlay && !ep.image) startVideo(ep.servers[0].url);

      loadServerButtons();
      loadEpisodes();
    }

    function startVideo(url) {
      videoPlayer.src = url;
      videoPlayer.style.display = "block";
      imageWrapper.style.display = "none";
    }

    playButton.addEventListener("click", () => {
      const ep = episodes[currentEpisodeIndex];
      startVideo(ep.servers[0].url);
    });

    function loadServerButtons() {
      serverButtons.innerHTML = "";
      const ep = episodes[currentEpisodeIndex];
      ep.servers.forEach(server => {
        const btn = document.createElement("button");
        btn.textContent = server.serverName;
        btn.className = "server-button";
        if (server.serverName === currentServerName) btn.classList.add("active");
        btn.addEventListener("click", () => {
          currentServerName = server.serverName;
          videoPlayer.src = server.url;
          startVideo(server.url);
          loadServerButtons();
        });
        serverButtons.appendChild(btn);
      });
    }

    function navigateEpisode(direction) {
      currentEpisodeIndex += direction;
      if (currentEpisodeIndex < 0) currentEpisodeIndex = 0;
      if (currentEpisodeIndex >= episodes.length) currentEpisodeIndex = episodes.length - 1;
      const newUrl = `?id=${getQueryParam("id")}&episode=${episodes[currentEpisodeIndex].number}`;
      history.pushState({}, "", newUrl);
      playEpisode(currentEpisodeIndex, false);
    }

    prevBtn.onclick = () => navigateEpisode(-1);
    nextBtn.onclick = () => navigateEpisode(1);

    window.onpopstate = () => {
      setEpisodeFromURL();
      loadEpisodes();
    };

    window.onload = loadEpisodesData;

  </script>

  <script>
    fetch('../navbar.html')
      .then(res => res.text())
      .then(data => document.getElementById('navbar-container').innerHTML = data);
  </script>

</body>
</html>
